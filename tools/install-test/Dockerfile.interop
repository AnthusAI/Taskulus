# Amazon Linux-based interoperability smoke:
# - Installs kanbus from PyPI
# - Installs kanbus (kbs binary) from crates.io
# - Installs beads CLI from crates.io
# - Seeds a shared fixture project and compares listings across all three
#
# Usage:
#   docker build -f tools/install-test/Dockerfile.interop -t kanbus-interop-smoke .
#   docker run --rm kanbus-interop-smoke

FROM amazonlinux:2023

ENV PATH="/root/.cargo/bin:/usr/local/go/bin:/root/go/bin:${PATH}" \
    RUSTUP_HOME=/root/.rustup \
    CARGO_HOME=/root/.cargo \
    CARGO_TERM_COLOR=always \
    PYTHONUNBUFFERED=1

RUN yum update -y && \
    yum install -y --allowerasing git gcc gcc-c++ make diffutils openssl-devel pkg-config curl tar python3.11 python3.11-pip golang jq && \
    python3.11 -m pip install --no-cache-dir --upgrade --ignore-installed pip && \
    python3.11 -m pip install --no-cache-dir kanbus && \
    curl https://sh.rustup.rs -sSf | sh -s -- -y && \
    /root/.cargo/bin/rustup install stable && \
    /root/.cargo/bin/rustup default stable && \
    /root/.cargo/bin/cargo install kanbus && \
    curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash

WORKDIR /workspace

COPY tools/install-test/scripts/run-interop-smoke.sh /usr/local/bin/run-interop-smoke.sh
RUN chmod +x /usr/local/bin/run-interop-smoke.sh

ENTRYPOINT ["/usr/local/bin/run-interop-smoke.sh"]
