name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.release_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install release tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install python-semantic-release build twine

      - name: Create release tag
        working-directory: python
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: semantic-release version

      - name: Publish release to PyPI
        working-directory: python
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: semantic-release publish

      - name: Capture release tag
        id: release_tag
        run: |
          git fetch --tags
          tag=$(git describe --tags --abbrev=0 2>/dev/null || true)
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

  rust-binaries:
    needs: publish
    if: ${{ needs.publish.outputs.release_tag != '' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: tskr
            archive: tar.gz
          - os: macos-14
            target: aarch64-apple-darwin
            binary: tskr
            archive: tar.gz
          - os: macos-14
            target: x86_64-apple-darwin
            binary: tskr
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: tskr.exe
            archive: zip
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }}

      - name: Package binary (tar.gz)
        if: ${{ matrix.archive == 'tar.gz' }}
        run: |
          mkdir -p dist
          cp rust/target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
          tar -czf dist/tskr-${{ matrix.target }}.tar.gz -C dist ${{ matrix.binary }}

      - name: Package binary (zip)
        if: ${{ matrix.archive == 'zip' && matrix.os != 'windows-latest' }}
        run: |
          mkdir -p dist
          cp rust/target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
          cd dist
          zip tskr-${{ matrix.target }}.zip ${{ matrix.binary }}

      - name: Package binary (zip, windows)
        if: ${{ matrix.archive == 'zip' && matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "rust/target/${{ matrix.target }}/release/${{ matrix.binary }}" "dist/${{ matrix.binary }}"
          Compress-Archive -Path "dist/${{ matrix.binary }}" -DestinationPath "dist/tskr-${{ matrix.target }}.zip" -Force

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish.outputs.release_tag }}
          files: |
            dist/tskr-${{ matrix.target }}.${{ matrix.archive }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  rust-crate:
    needs: publish
    if: ${{ needs.publish.outputs.release_tag != '' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: rust
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo directories
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('rust/Cargo.lock') }}

      - name: Sync crate version to release tag
        run: |
          tag_version="${{ needs.publish.outputs.release_tag }}"
          tag_version="${tag_version#v}"
          python - <<'PY' "$tag_version"
          import pathlib, re, sys
          path = pathlib.Path("Cargo.toml")
          text = path.read_text()
          version = sys.argv[1]
          def replace_version(contents: str, version: str) -> str:
              pattern = r'(?m)^version\s*=\s*"[^"]*"'
              return re.sub(pattern, f'version = "{version}"', contents, count=1)
          new_text = replace_version(text, version)
          if new_text == text:
              print("version field not updated; check Cargo.toml format")
              sys.exit(1)
          path.write_text(new_text)
          PY

      - name: fmt
        run: cargo fmt --check

      - name: clippy
        run: cargo clippy --locked -- -D warnings

      - name: test
        run: cargo test --locked

      - name: package (verification)
        run: cargo package --locked

      - name: publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --locked --token "$CARGO_REGISTRY_TOKEN"
