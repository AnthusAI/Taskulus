name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["main"]

permissions:
  contents: write

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.release_tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install release tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install python-semantic-release build twine

      - name: Create release tag
        working-directory: python
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: semantic-release version

      - name: Publish release to PyPI
        working-directory: python
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: semantic-release publish

      - name: Capture release tag
        id: release_tag
        run: |
          git fetch --tags
          tag=$(git describe --tags --abbrev=0 2>/dev/null || true)
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

  rust-binaries:
    needs: publish
    if: ${{ needs.publish.outputs.release_tag != '' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: tskr
            archive: tar.gz
          - os: macos-13
            target: x86_64-apple-darwin
            binary: tskr
            archive: tar.gz
          - os: macos-14
            target: aarch64-apple-darwin
            binary: tskr
            archive: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: tskr.exe
            archive: zip
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build binary
        run: |
          cd rust
          cargo build --release --target ${{ matrix.target }}

      - name: Package binary (tar.gz)
        if: ${{ matrix.archive == 'tar.gz' }}
        run: |
          mkdir -p dist
          cp rust/target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
          tar -czf dist/tskr-${{ matrix.target }}.tar.gz -C dist ${{ matrix.binary }}

      - name: Package binary (zip)
        if: ${{ matrix.archive == 'zip' && matrix.os != 'windows-latest' }}
        run: |
          mkdir -p dist
          cp rust/target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
          cd dist
          zip tskr-${{ matrix.target }}.zip ${{ matrix.binary }}

      - name: Package binary (zip, windows)
        if: ${{ matrix.archive == 'zip' && matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "rust/target/${{ matrix.target }}/release/${{ matrix.binary }}" "dist/${{ matrix.binary }}"
          Compress-Archive -Path "dist/${{ matrix.binary }}" -DestinationPath "dist/tskr-${{ matrix.target }}.zip" -Force

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.publish.outputs.release_tag }}
          files: |
            dist/tskr-${{ matrix.target }}.${{ matrix.archive }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
