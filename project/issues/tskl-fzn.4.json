{
  "id": "tskl-fzn.4",
  "title": "Performance benchmarks for indexing",
  "description": "Create benchmarks: 1000 issues, measure index build time, cache load time. Must meet targets: Python <50ms, Rust <1ms.",
  "type": "task",
  "status": "in_progress",
  "priority": 2,
  "assignee": "Ryan Alyn Porter",
  "creator": "Ryan Alyn Porter",
  "parent": "tskl-fzn",
  "labels": [],
  "dependencies": [],
  "comments": [
    {
      "author": "Ryan Alyn Porter",
      "text": "Profiling: isolated cProfile on build_index_from_directory and load_cache_if_valid after warming imports. build_index_from_directory ~0.066s for 1000 issues. Top cumulative time: pathlib read_text/open (0.049s), sorting glob results (0.008s), json loads (0.004s), pydantic model_validate (~0.002s). load_cache_if_valid ~0.010s; dominated by collect_issue_file_mtimes (0.006s), pathlib glob/stat, and pydantic model_validate. Next steps: reduce file IO and sorting overhead, consider faster directory scan or bypassing read_text per file.",
      "created_at": "2026-02-11T09:16:57Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Next step: reduce sorting overhead in index build by sorting directory entries by filename (not full path) in both Python and Rust for deterministic order with less Path comparison cost. Will re-run benchmarks after change.",
      "created_at": "2026-02-11T09:17:57Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Implemented filename-based sorting for index build: Python now sorts issue paths by path.name; Rust sorts read_dir entries by file_name. Benchmarks: python build_ms 58.54, cache_load_ms 6.90; rust release build_ms 50.05, cache_load_ms 5.05 (targets still unmet). Tests: python -m pytest tests/test_index.py, cargo test --test index.",
      "created_at": "2026-02-11T09:18:32Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Switched Python index scan from glob to iterdir+suffix filter (still sorting by filename). Benchmarks: python build_ms 47.07, cache_load_ms 7.10 (build now under 50ms target); rust release build_ms 47.99, cache_load_ms 8.11. Tests: python -m pytest tests/test_index.py, cargo test --test index.",
      "created_at": "2026-02-11T09:20:16Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Updated Python collect_issue_file_mtimes to use iterdir + suffix filter. Benchmarks fluctuate; sample run: build_ms 47.40, cache_load_ms 6.18 (other runs 53.93/7.51, 59.74/7.19). Tests: python -m pytest tests/test_cache_serialization.py tests/test_index.py.",
      "created_at": "2026-02-11T09:21:37Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Rust cache mtime scan now uses entry.file_name (no extra path.file_name call) and entry.metadata (already in scope). Bench: rust release build_ms 60.29, cache_load_ms 4.88. Tests: cargo test --test index. Note: cargo test --test cache has no target.",
      "created_at": "2026-02-11T09:22:36Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Rust index build now filters json entries before sorting (reduces sort set). Bench: rust release build_ms 62.09, cache_load_ms 5.75 (no improvement; build a bit higher). Tests: cargo test --test index.",
      "created_at": "2026-02-11T09:24:23Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Rust index build now reads JSON as bytes (fs::read + serde_json::from_slice) instead of read_to_string/from_str. Bench: rust release build_ms 49.79, cache_load_ms 5.10. Tests: cargo test --test index.",
      "created_at": "2026-02-11T09:25:31Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Python index now reads JSON bytes (read_bytes + json.loads) instead of read_text. Bench: python build_ms 45.86, cache_load_ms 6.96. Tests: python -m pytest tests/test_index.py.",
      "created_at": "2026-02-11T09:26:16Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Plan: small readability refactor in index build to centralize issue loading/parsing in helper functions (Python and Rust). No behavior change; run index tests after.",
      "created_at": "2026-02-11T09:27:02Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Refactor: centralized issue JSON loading in helper functions (Python _load_issue_data, Rust read_issue_data) for readability; no behavior change. Tests: python -m pytest tests/test_index.py; cargo test --test index.",
      "created_at": "2026-02-11T09:27:21Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Readability: added _normalize_mtime helper in python cache module, used in collect_issue_file_mtimes (no behavior change). Tests: python -m pytest tests/test_cache_serialization.py.",
      "created_at": "2026-02-11T09:28:17Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Readability: extracted mtime_from_entry helper in rust cache to encapsulate metadata/mtime conversion. Tests: cargo test --test index.",
      "created_at": "2026-02-11T09:29:24Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Readability: centralized issue indexing in helper functions (Python _add_issue_to_index, Rust add_issue_to_index). No behavior change. Tests: python -m pytest tests/test_index.py; cargo test --test index.",
      "created_at": "2026-02-11T09:31:07Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Checked for additional small readability or perf tweaks within scope; no further low-risk changes found without broader refactors. Pausing to avoid scope expansion.",
      "created_at": "2026-02-11T09:31:46Z"
    },
    {
      "author": "Ryan Alyn Porter",
      "text": "Python index/cache now use os.scandir for file enumeration (issue paths and mtimes). Tests: python -m pytest tests/test_cache_serialization.py tests/test_index.py. Benchmark sample: build_ms 62.14, cache_load_ms 7.32 (worse on this run; may be noise).",
      "created_at": "2026-02-11T12:30:36Z"
    }
  ],
  "created_at": "2026-02-11T01:41:01.363384Z",
  "updated_at": "2026-02-11T08:18:02.991078Z",
  "closed_at": null,
  "custom": {
    "beads_owner": "rap@endymion.com",
    "beads_notes": "Plan: 1) Locate existing benchmark tooling. 2) Add minimal benchmark harness for index build and cache load using 1000 issues. 3) Document targets and run results. 4) Wire into tests if appropriate. 5) Update task and close.\nImplemented benchmark harnesses: tools/benchmark_index.py and rust/src/bin/index_benchmark.rs. Normalized cache mtimes to 6 decimal places in both implementations to avoid precision mismatch. Ran benchmarks: Python build ~66.34ms, cache load ~7.58ms; Rust release build ~51.06ms, cache load ~5.71ms. Targets (Python <50ms, Rust <1ms) not met yet. Tests: python -m pytest python/tests/test_cache_serialization.py, cargo test.\nAdded benchmark instructions to README: run python tools/benchmark_index.py and rust cargo run --release --bin index_benchmark.\nSwitching focus to performance improvements within scope. Next: profile index build and cache load to identify hotspots without changing behavior."
  }
}